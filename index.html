<meta name=viewport value="width=device-width,initial-scale=1"><title>psm</title><style>*{margin:0;top:0;left:0;font-size:14px;font-family:monospace;padding:0}a{color:#0ff}p{padding-bottom:1.4rem}body{background:#222;color:gray}main{display:flex;flex-direction:row;justify-content:start}.code textarea{background:0 0;border:none;outline:0;resize:none;color:gray;height:100vh;width:70vw;padding:2rem}.menu{border-left:2px solid #333;height:100vh;width:100%}.menu>div{padding:2rem}.log{border-top:2px solid #333}.log .list{width:100%;height:100%;overflow-y:scroll;background:#191919;max-height:10rem;list-style-type:none}.log li{padding-top:.7rem;padding-left:1rem}input[type=button]{border:none;background:0 0;outline:0}input[type=button]:hover{cursor:pointer;text-decoration:underline}.assemble{color:#0f0}.copy{color:#fff}@media screen and (max-width:1000px){.code textarea{width:55vw}}@media screen and (max-width:800px){main{display:block}.code textarea{height:60vh;width:100vw}.menu{border:none;border-top:2px solid #333;height:unset}}::selection{background:#888}.error{color:#ff2049}</style><main><div class=code><textarea spellcheck=false></textarea></div><div class=menu><div><p>psm@1.0.1 &nbsp; <a href=#>npm</a>&nbsp; <a href=https://github.com/Oelin/psm>git</a>&nbsp; <a href=/manual.html>manual</a><p><p><input class=assemble type=button value="ðŸ’¾ assemble"><p><input class=copy type=button value="ðŸ“ copy binary"></div><div class=log><p>log<div><ul class=list></ul></div></div></div></main><script>psm=a=>{let b=["addrr","addrv","subrr","subrv","andrr","orrr","xorrr","notr","bv","movrr","movrv","loadrv","storr","stovr","testrr","pass"],c=a=>a.replaceAll(/^\s*[\r\n]+|#.*/gm,"").replaceAll(/:[\n\s]+/g,":").trim(),d=a=>{let b;return a.map(a=>(b=a.match(/^([a-zA-Z_][\w_]*):/))&&b[1])},e=a=>{a=c(a);let b=a.split("\n");return d(b).forEach((b,c)=>{a=a.replaceAll(`$${b}`,c).replaceAll(`${b}:`,"")}),a},f=a=>a.replaceAll(","," ").replaceAll(/\s+/g," ").split(" "),g=a=>a.map(b=>isNaN(parseInt(b))?"r":"v"),h=a=>[...a.matchAll(/("[^"]*"|\d+)/g)].map(a=>JSON.parse(a[0])),i=a=>{let b=f(a),[c,d,e]=b.shift().match(/([abd-y]+)([zc])?/),h=g(b),i=b.filter((b,a)=>"r"==h[a]).map(a=>"abcd".indexOf(a)),j=parseInt(b[h.indexOf("v")]);return{k:d+h.join(""),f:e,v:j,r:i}},j=a=>a.map(a=>a.match(/^[a-z]+$|[a-z]+\s(\s*([a-d]|\d+)(,|$))*$/)?i(a):h(a));return(a=>{let c=j(e(a).split("\n"));return new Int32Array(c.map(a=>{if(a.k){let c=b.indexOf(a.k),d="cz".indexOf(a.f||"c"),e=0+!!a.f,f=-1<a.r[0]?a.r[0]:0,g=-1<a.r[1]?a.r[1]:0;a.k.startsWith("sto")&&([f,g]=[g,f]);let h=a.v||0;return h+(g<<21)+(f<<23)+(e<<25)+(d<<26)+(c<<27)}return a.map(a=>"string"==typeof a?a.split("").map(a=>a.charCodeAt(0)):a)}).flat())})(a)};{const PSM_RE=/./;let log=document.querySelector(".log .list"),assemble=document.querySelector("input.assemble"),copy=document.querySelector("input.copy"),code=document.querySelector(".code textarea");code.innerText="# type your code here\n",code.focus();function err(a){log.innerHTML+=`<li class="error">${a}</li>`}function put(a){log.innerHTML+=`<li>${a}</li>`}assemble.onclick=function(){log.innerHTML="";let a,b=code.value;try{put("checking code...");let c=b.split("\n");b||put("your code is very nihilistic"),c.forEach((a,b)=>{if(!a.match(PSM_RE))throw`wrong syntax on line ${b+1}`}),put("no syntax errors were found"),a=psm(b)}catch(a){return err(a),void err("psm could not assemble your code")}a&&(put(`produced ${4*a.length} bytes of machine code`),localStorage.setItem("binary",JSON.stringify([...a])))},copy.onclick=function(){window.navigator.clipboard.writeText(localStorage.getItem("binary"))};}</script>
